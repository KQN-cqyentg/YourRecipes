<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <div class="container">
      <!-- Thanh Navbar -->
      <div class="header">
        <div class="one">
          <h1 class="logo">
            <img src="./assets/img/recetas.png" alt="logo" /><b>Your Recipes</b>
          </h1>
          <div class="OurUser">
            <button class="btnProfile hidden">
              <a href="./admin.html"
                ><i class="bi bi-person-circle"></i> Profile</a
              >
            </button>
            <p class="email_admin"></p>
            <button class="btnLogout hidden">Log out</button>

            <button class="btnLogin"><a href="./login.html">Log in</a></button>
            <!-- <button class="btnRegister"><a href="">Register</a></button> -->
          </div>
        </div>
        <div class="pages">
          <button class="page pHome"><a href="./index.html">Home</a></button>
          <button class="page pDishes">
            <a href="./list_dishes.html">List of dishes</a>
          </button>
          <button class="page pAbout">
            <a href="./about_contact.html">About & Contact</a>
          </button>
          <button class="page btnManage">
            <a href="./manage.html">My Blog</a>
          </button>
        </div>
      </div>
      <!-- /Thanh Navbar -->

      <div class="container_body">
        <div class="profile-header">
            <div class="avatar-section">
              <div class="avatar-wrapper">
                <img id="avatarPreview" src="https://via.placeholder.com/150/1a73e8/ffffff?text=Avatar" alt="Avatar" />
                <div class="avatar-overlay">
                  <label for="avatarInput" class="avatar-upload-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                      <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    <span>Đổi ảnh</span>
                  </label>
                  <input type="file" id="avatarInput" accept="image/*" style="display: none;" />
                </div>
              </div>
              <button type="button" id="removeAvatarBtn" class="btn-remove-avatar" style="display: none;">
                Xóa ảnh
              </button>
            </div>
          </div>
        
        <div class="profile_page">
          <form action="">
            <h2>Profile</h2>

            <label for=""><b>Fullname:</b></label>
            <input type="text" id="fullname" placeholder="Fullname" />

            <label for=""><b>Birthday:</b></label>
            <input type="date" id="birth" />

            <label for=""><b>Username:</b></label>
            <input type="text" id="username" placeholder="Username" disabled />

            <div>
              <button type="button" class="btnSave">Save changes</button>
              <button
                type="button"
                class="btnCancle"
                onclick="window.location.href='index.html'"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Chân trang -->
      <div class="footer">
        <div class="footer_1">
          <div>
            <h1 class="logo">
              <img src="./assets/img/recetas.png" alt="logo" /><b
                >Your Recipes</b
              >
            </h1>
          </div>

          <div class="part navigate">
            <span><b>Navigate</b></span>
            <div class="part_children">
              <a href="./index.html">Home</a> <br />
              <a href="./list_dishes.html">List of dishes</a> <br />
              <a href="./about_contact.html">About</a>
            </div>
          </div>
        </div>

        <div class="web_address">
          © 2025 <a href="./index.html">YourRecipes</a> - Find your favourite
          recipes by KieuQuynhNgan.
        </div>
      </div>
      <!-- /Chân trang -->
    </div>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        updateProfile,
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDl8yPDCfPIn_LLrXPRqa1BXvQXIA54_-I",
        authDomain: "jsi36-644e1.firebaseapp.com",
        projectId: "jsi36-644e1",
        storageBucket: "jsi36-644e1.firebasestorage.app",
        messagingSenderId: "156685119367",
        appId: "1:156685119367:web:d379c9de457e28ee806d22",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let currentUser = null;
      let selectedFile = null;
      let currentAvatarUrl = null;

      //Kiểm tra đăng nhập
      let btnProfile = document.querySelector(".btnProfile");
      let email_admin = document.querySelector(".email_admin");
      let btn_Logout = document.querySelector(".btnLogout");
      let btn_Login = document.querySelector(".btnLogin");

      onAuthStateChanged(auth, (user) => {
        if (user) {
          btnProfile.classList.remove("hidden");
          btn_Logout.classList.remove("hidden");
          btn_Login.classList.add("hidden");
          currentUser = user;
          email_admin.textContent = user.email;
          loadUserProfile();
        } else {
          btnProfile.classList.add("hidden");
          email_admin.textContent = "";
          btn_Logout.classList.add("hidden");
          btn_Login.classList.remove("hidden");
          window.location.href = "index.html";
        }
      });

      // Đăng xuất
      btn_Logout.addEventListener("click", async () => {
        await signOut(auth);
        btnProfile.classList.add("hidden");
        email_admin.textContent = "";
        btn_Logout.classList.add("hidden");
        btn_Login.classList.remove("hidden");
      });

      // Tải thông tin người dùng
      let fullname = document.querySelector("#fullname");
      let birth = document.querySelector("#birth");
      let username = document.querySelector("#username");

      async function loadUserProfile() {
        try {
          if (!currentUser) return;

          // Email hiện tại -> username (tuỳ logic của bạn)
          username.value = currentUser.email || "";

          const docRef = doc(db, "users", currentUser.uid);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            const userData = docSnap.data();

            // Đổ dữ liệu lên input
            fullname.value = userData.fullName || "";
            birth.value = userData.birthDate || "";
            if (userData.avatarUrl) {
              currentAvatarUrl = userData.avatarUrl;
              document.getElementById("avatarPreview").src = userData.avatarUrl;
              document.getElementById("removeAvatarBtn").style.display = "block";
            }

          } else {
            // Chưa có profile trong Firestore
            fullname.value = "";
            birth.value = "";
          }
        } catch (error) {
          console.error("Lỗi tải dữ liệu:", error);
        }
      }
      // Xử lý chọn ảnh
      document.getElementById("avatarInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          // Kiểm tra kích thước file (tối đa 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert("Kích thước ảnh không được vượt quá 5MB!");
            return;
          }

          // Kiểm tra loại file
          if (!file.type.startsWith("image/")) {
            alert("Vui lòng chọn file ảnh!");
            return;
          }

          selectedFile = file;

          // Preview ảnh
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById("avatarPreview").src = e.target.result;
            document.getElementById("removeAvatarBtn").style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      });

      // Xóa avatar
      document.getElementById("removeAvatarBtn").addEventListener("click", async () => {
        if (confirm("Bạn có chắc muốn xóa ảnh đại diện?")) {
          try {
            // Cập nhật Firestore
            const docRef = doc(db, "users", currentUser.uid);
            await setDoc(docRef, { avatarUrl: null }, { merge: true });

            // Cập nhật Auth profile (chỉ displayName)
            await updateProfile(currentUser, { 
              displayName: currentUser.displayName 
            });

            // Reset UI
            document.getElementById("avatarPreview").src = "https://via.placeholder.com/150/1a73e8/ffffff?text=Avatar";
            document.getElementById("removeAvatarBtn").style.display = "none";
            selectedFile = null;
            currentAvatarUrl = null;

            alert("Đã xóa ảnh đại diện!");
          } catch (error) {
            alert("Lỗi xóa ảnh: " + error.message);
          }
        }
      });

      // Lưu thông tin
      let btnSave = document.querySelector(".btnSave");
      let btnCancle = document.querySelector(".btnCancle");
      btnSave.addEventListener("click", async () => {
        // Validation
        if (!fullname.value) {
          alert("Vui lòng nhập họ và tên!");
          return;
        }
        if (!birth.value) {
          alert("Vui lòng chọn ngày sinh!");
          return;
        }

        try {
          let avatarUrl = currentAvatarUrl;

          // Lưu ảnh vào Firestore dạng base64 nếu có ảnh mới
          if (selectedFile) {
            const reader = new FileReader();
            reader.onload = async (e) => {
        try {
          // Lưu base64 vào Firestore
                const base64Image = e.target.result;
          // Cập nhật Firestore
          const docRef = doc(db, "users", currentUser.uid);
          await setDoc(
            docRef,
            {
              fullName: fullname.value,
              birthDate: birth.value,
              avatarUrl: base64Image,
              email: currentUser.email,
              updatedAt: new Date().toISOString(),
            },
            { merge: true }
          );
          // Cập nhật Auth profile (chỉ displayName, không lưu photoURL vì base64 quá dài)
                await updateProfile(currentUser, {
                  displayName: fullname.value,
                });

                alert("Cập nhật thông tin thành công!");
                selectedFile = null;
                currentAvatarUrl = base64Image;
              } catch (error) {
                alert("Có lỗi xảy ra: " + error.message);
              }
            };
            reader.readAsDataURL(selectedFile);
            return;
          }

          // Cập nhật Firestore nếu không có ảnh mới
          const docRef = doc(db, "users", currentUser.uid);
          await setDoc(
            docRef,
            {
              fullName: fullname.value,
              birthDate: birth.value,
              avatarUrl: avatarUrl,
              email: currentUser.email,
              updatedAt: new Date().toISOString(),
            },
            { merge: true }
          );          

          // Cập nhật Auth profile
          await updateProfile(currentUser, {
            displayName: fullname.value,
          });
          alert("Cập nhật thông tin thành công!");
          selectedFile = null;
          currentAvatarUrl = avatarUrl;
        } catch (error) {
          alert("Có lỗi xảy ra: " + error.message);
        }
      });
    </script>
  </body>
</html>
