<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <div class="container">
      <!-- Thanh Navbar -->
      <div class="header">
        <div class="one">
          <h1 class="logo">
            <img src="./assets/img/recetas.png" alt="logo" /><b>Your Recipes</b>
          </h1>
          <div class="OurUser">
            <button class="btnProfile">
              <a href="./admin.html"
                ><i class="bi bi-person-circle"></i> Profile</a
              >
            </button>
            <p class="email_admin"></p>
            <button class="btnLogout">Log out</button>

            <button class="btnLogin"><a href="./login.html">Log in</a></button>
            <!-- <button class="btnRegister">
              <a href="./register.html">Register</a>
            </button> -->
          </div>
        </div>
        <div class="pages">
          <button class="page pHome"><a href="./index.html">Home</a></button>
          <button class="page pDishes">
            <a href="./list_dishes.html">List of dishes</a>
          </button>
          <button class="page pAbout">
            <a href="./about_contact.html">About & Contact</a>
          </button>
          <button class="page btnManage">
            <a href="./manage.html">My Blog</a>
          </button>
        </div>
      </div>
      <!-- /Thanh Navbar -->

      <div class="container_body">
        <!-- ƒêƒÉng b√†i -->
        <div class="post_section" id="newPostSection">
          <form id="recipeForm" class="post-form">
            <h2>New Post</h2>

            <div class="post_1">
              <div class="img-section">
                <label for="">Image:</label>
                <div class="img-wrapper">
                  <img
                    id="imgPreview"
                    src="https://via.placeholder.com/150/1a73e8/ffffff?text=Avatar"
                    alt="Avatar"
                  />
                  <div class="img-overlay">
                    <label for="imgInput" class="img-upload-btn">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path
                          d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                        ></path>
                        <circle cx="12" cy="13" r="4"></circle>
                      </svg>
                      <span>ƒê·ªïi ·∫£nh</span>
                    </label>
                    <input
                      type="file"
                      id="imgInput"
                      accept="image/*"
                      style="display: none"
                    />
                  </div>
                </div>
                <button
                  type="button"
                  id="removeimgBtn"
                  class="btn-remove-img"
                  style="display: none"
                >
                  X√≥a ·∫£nh
                </button>
              </div>

              <!-- <div class="post_2">
                <div>
                  <label for="">Title:</label>
                  <input type="text" id="title" placeholder="Title" required />
                </div>

                <div>
                  <label for="">Date posted:</label>
                  <input type="date" id="date" required />
                </div>
              </div> -->
            </div>

            <label for="">Title:</label>
            <input type="text" id="title" placeholder="Title" required />

            <label for="">Desription:</label>
            <textarea
              id="description"
              placeholder="Description"
              rows="6"
              required
            ></textarea>

            <div class="post_3">
              <button type="button" class="btnPost">Post</button>
              <button type="button" class="btnCancle">Cancel</button>
            </div>
          </form>
        </div>
        <!-- B√¨a ƒëƒÉng c·ªßa b·∫°n -->
        <div class="yourpost">
          <h2>My Posts</h2>
          <div id="postList" class="post-list"></div>
        </div>
      </div>

      <!-- Ch√¢n trang -->
      <div class="footer">
        <div class="footer_1">
          <div>
            <h1 class="logo">
              <img src="./assets/img/recetas.png" alt="logo" /><b
                >Your Recipes</b
              >
            </h1>
          </div>

          <div class="part navigate">
            <span><b>Navigate</b></span>
            <div class="part_children">
              <a href="./index.html">Home</a> <br />
              <a href="./list_dishes.html">List of dishes</a> <br />
              <a href="./about_contact.html">About</a>
            </div>
          </div>
        </div>
        <div class="web_address">
          ¬© 2025 <a href="./index.html">YourRecipes</a> - Find your favourite
          recipes by KieuQuynhNgan.
        </div>
      </div>
      <!-- /Ch√¢n trang -->
    </div>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import {
        collection,
        getDoc,
        doc,
        setDoc,
        getFirestore,
        addDoc,
        updateDoc,
        getDocs,
        deleteDoc,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDl8yPDCfPIn_LLrXPRqa1BXvQXIA54_-I",
        authDomain: "jsi36-644e1.firebaseapp.com",
        projectId: "jsi36-644e1",
        storageBucket: "jsi36-644e1.firebasestorage.app",
        messagingSenderId: "156685119367",
        appId: "1:156685119367:web:d379c9de457e28ee806d22",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let currentUser = null;
      let selectedFile = null;
      let editingPostId = null;

      //Ki·ªÉm tra ƒëƒÉng nh·∫≠p
      let btnProfile = document.querySelector(".btnProfile");
      let email_admin = document.querySelector(".email_admin");
      let btn_Logout = document.querySelector(".btnLogout");
      let btn_Login = document.querySelector(".btnLogin");
      let btnManage = document.querySelector(".btnManage");

      onAuthStateChanged(auth, (user) => {
        if (user) {
          btnManage.classList.remove("hidden");
          btnProfile.classList.remove("hidden");
          btn_Logout.classList.remove("hidden");
          btn_Login.classList.add("hidden");
          currentUser = user;
          email_admin.textContent = user.email;

          loadMyPosts();
        } else {
          btnManage.classList.add("hidden");
          btnProfile.classList.add("hidden");
          email_admin.textContent = "";
          btn_Logout.classList.add("hidden");
          btn_Login.classList.remove("hidden");
          window.location.href = "index.html";
        }
      });
      // ƒêƒÉng xu·∫•t
      btn_Logout.addEventListener("click", async () => {
        await signOut(auth);
        btnManage.classList.add("hidden");
        btnProfile.classList.add("hidden");
        email_admin.textContent = "";
        btn_Logout.classList.add("hidden");
        btn_Login.classList.remove("hidden");
      });

      // H·ªßy
      const btnCancle = document.querySelector(".btnCancle");
      btnCancle.addEventListener("click", () => {
        if (confirm("B·∫°n c√≥ mu·ªën h·ªßy ch·ªânh s·ª≠a kh√¥ng?")) {
          resetForm();
          window.location.href = "index.html";
        }
      });
      // X·ª≠ l√Ω ch·ªçn ·∫£nh
      document.getElementById("imgInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (t·ªëi ƒëa 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert("K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB!");
            return;
          }

          // Ki·ªÉm tra lo·∫°i file
          if (!file.type.startsWith("image/")) {
            alert("Vui l√≤ng ch·ªçn file ·∫£nh!");
            return;
          }

          selectedFile = file;

          // Preview ·∫£nh
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById("imgPreview").src = e.target.result;
            document.getElementById("removeimgBtn").style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      });

      /* ===== RESET FORM ===== */
      function resetForm() {
        recipeForm.reset();
        imgPreview.src = "https://via.placeholder.com/150";
        removeimgBtn.style.display = "none";
        selectedFile = null;
        editingPostId = null;
        document.querySelector(".btnPost").textContent = "Post";
      }

      /* ===== CREATE / UPDATE ===== */
      document.querySelector(".btnPost").onclick = async () => {
        const title = document.getElementById("title").value;
        const des = document.getElementById("description").value;

        if (!title || !des) {
          alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß");
          return;
        }

        let img = null;
        if (selectedFile) {
          img = await new Promise((resolve) => {
            const r = new FileReader();
            r.onload = (e) => resolve(e.target.result);
            r.readAsDataURL(selectedFile);
          });
        }

        if (editingPostId) {
          const updateData = {
            title,
            des,
            createdAt: new Date().toISOString(),
          };

          if (img) updateData.img = img; // ch·ªâ update ·∫£nh khi c√≥ ·∫£nh m·ªõi

          await updateDoc(doc(db, "FoodRecipes", editingPostId), updateData);
          alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
        } else {
          await addDoc(collection(db, "FoodRecipes"), {
            title,
            des,
            img,
            userId: currentUser.uid,
            email: currentUser.email,
            createdAt: new Date().toISOString(),
          });
          alert("ƒêƒÉng b√†i th√†nh c√¥ng!");
        }

        resetForm();
        loadMyPosts();
      };

      /* ===== LOAD MY POSTS ===== */
      async function loadMyPosts() {
  postList.innerHTML = "";

  const q = query(
    collection(db, "FoodRecipes"),
    where("userId", "==", currentUser.uid)
  );

  const snap = await getDocs(q);

  if (snap.empty) {
    postList.innerHTML = "<p>B·∫°n ch∆∞a ƒëƒÉng b√†i n√†o.</p>";
    return;
  }

  for (const docSnap of snap.docs) {
    const post = docSnap.data();

    // üëâ L·∫§Y USER
    const userSnap = await getDoc(doc(db, "users", post.userId));
    const user = userSnap.exists() ? userSnap.data() : {};

    postList.innerHTML += `
      <div class="post-card">
        <div class="post-card_1">
          <img src="${post.img || "https://via.placeholder.com/150"}" />
        </div>

        <div class="post-card_2">
          <a href="./the_dish.html?id=${docSnap.id}">
            ${post.title}
          </a>
          <span class="the-Blogger">
                        <div class="avatar_2"> <img alt="" src="${user.avatarUrl}"> </div>
                         ${user.fullName}
                      </span>
          <span class="the-Date">${post.createdAt || ""}</span>
          <p class="post-desc">${post.des}</p>
        </div>

        <div class="post-card_3">
          <button class="E" onclick="editPost('${docSnap.id}')">Edit</button>
          <button class="D" onclick="deletePost('${docSnap.id}')">Delete</button>
        </div>
      </div>
    `;
  }
}

      /* ===== EDIT ===== */
      window.editPost = async (id) => {
        document
          .getElementById("newPostSection")
          .scrollIntoView({ behavior: "smooth", block: "start" });

        const snap = await getDoc(doc(db, "FoodRecipes", id));
        if (!snap.exists()) return;

        const data = snap.data();
        editingPostId = id;

        title.value = data.title;
        description.value = data.des;
        imgPreview.src = data.img || "https://via.placeholder.com/150";

        document.querySelector(".btnPost").textContent = "Update";
      };

      /* ===== DELETE ===== */
      window.deletePost = async (id) => {
        if (!confirm("X√≥a b√†i n√†y?")) return;
        await deleteDoc(doc(db, "FoodRecipes", id));
        loadMyPosts();
      };
    </script>
  </body>
</html>
