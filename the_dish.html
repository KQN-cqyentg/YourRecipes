<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <div class="container">
      <!-- Thanh Navbar -->
      <div class="header">
        <div class="one">
          <h1 class="logo">
            <img src="./assets/img/recetas.png" alt="logo" /><b>Your Recipes</b>
          </h1>
          <div class="OurUser">
            <button class="btnProfile hidden">
              <a href="./admin.html"
                ><i class="bi bi-person-circle"></i> Profile</a
              >
            </button>
            <p class="email_admin"></p>
            <button class="btnLogout hidden">Log out</button>

            <button class="btnLogin"><a href="./login.html">Log in</a></button>
            <!-- <button class="btnRegister"><a href="">Register</a></button> -->
          </div>
        </div>
        <div class="pages">
          <button class="page pHome"><a href="./index.html">Home</a></button>
          <button class="page pDishes">
            <a href="./list_dishes.html">List of dishes</a>
          </button>
          <button class="page pAbout">
            <a href="./about_contact.html">About & Contact</a>
          </button>
          <button class="page btnManage">
            <a href="./manage.html">My Blog</a>
          </button>
        </div>
      </div>
      <!-- /Thanh Navbar -->

      <div class="container_dish">
        <div class="hero">
          <img src="" alt="" class="hero_img" />

          <div class="overlay"></div>

          <div class="hero-content">
            <h1 class="title_dish" id="title"></h1>

            <div class="meta">
              <div class="avatar_dish" id="avatar">
                <img src="" alt="author" />
              </div>

              <div class="meta-text">
                <span>
                  <div class="author" id="name"></div>
                  -
                  <div class="date_dish" id="date"></div>
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="dish_content">
          <div class="description"></div>
          <div class="some_dishes">
            <h3>Hi</h3>
          </div>
        </div>
      </div>

      <!-- Chân trang -->
      <div class="footer">
        <div class="footer_1">
          <div>
            <h1 class="logo">
              <img src="./assets/img/recetas.png" alt="logo" /><b
                >Your Recipes</b
              >
            </h1>
          </div>

          <div class="part navigate">
            <span><b>Navigate</b></span>
            <div class="part_children">
              <a href="./index.html">Home</a> <br />
              <a href="./list_dishes.html">List of dishes</a> <br />
              <a href="./about_contact.html">About</a>
            </div>
          </div>
        </div>

        <div class="web_address">
          © 2025 <a href="./index.html">YourRecipes</a> - Find your favourite
          recipes by KieuQuynhNgan.
        </div>
      </div>
      <!-- /Chân trang -->
    </div>

    <script type="module">
      window.addEventListener("load", () => {
        document.body.classList.add("loaded");
      });

    //  const hero = document.querySelector(".hero_img");
    //  window.addEventListener("scroll", () => {
    //    const scrollY = window.scrollY;
    //    hero.style.backgroundPositionY = `${scrollY * 0.4}px`;
    //  });

      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
      import {
        collection,
        getDocs,
        doc,
        getDoc,
        getFirestore,
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDl8yPDCfPIn_LLrXPRqa1BXvQXIA54_-I",
        authDomain: "jsi36-644e1.firebaseapp.com",
        projectId: "jsi36-644e1",
        storageBucket: "jsi36-644e1.firebasestorage.app",
        messagingSenderId: "156685119367",
        appId: "1:156685119367:web:d379c9de457e28ee806d22",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let currentUser = null;
      let selectedFile = null;
      let currentAvatarUrl = null;

      //Kiểm tra đăng nhập
      let btnProfile = document.querySelector(".btnProfile");
      let email_admin = document.querySelector(".email_admin");
      let btn_Logout = document.querySelector(".btnLogout");
      let btn_Login = document.querySelector(".btnLogin");
      let btnManage = document.querySelector(".btnManage");

      onAuthStateChanged(auth, (user) => {
        if (user) {
          btnManage.classList.remove("hidden");
          btnProfile.classList.remove("hidden");
          btn_Logout.classList.remove("hidden");
          btn_Login.classList.add("hidden");
          currentUser = user;
          email_admin.textContent = user.email;
        } else {
          btnManage.classList.add("hidden");
          btnProfile.classList.add("hidden");
          email_admin.textContent = "";
          btn_Logout.classList.add("hidden");
          btn_Login.classList.remove("hidden");
        }
      });
      // Đăng xuất
      btn_Logout.addEventListener("click", async () => {
        await signOut(auth);
        btnManage.classList.add("hidden");
        btnProfile.classList.add("hidden");
        email_admin.textContent = "";
        btn_Logout.classList.add("hidden");
        btn_Login.classList.remove("hidden");
      });

      //  <div class="hero-content">
      //        <h1 class="title_dish" id="title">
      //
      //        </h1>
      //        <div class="meta">
      //          <div class="avatar_dish" id="avatar">
      //            <img src="" alt="author" />
      //          </div>
      //          <div class="meta-text">
      //            <span class="author" id="name"></span>
      //            <span class="date_dish" id="date"></span>
      //          </div>
      //        </div>
      //      </div>
      // Lấy id từ URL
      const params = new URLSearchParams(window.location.search);
      const recipeId = params.get("id");
      console.log("Recipe ID from URL:", recipeId);

      // Render UI

      async function loadRecipe() {
        try {
          if (!recipeId) {
            alert("Recipe id is missing!");
            window.location.href = "index.html";
            return;
          }

          /* ========= LẤY RECIPE ========= */
          const recipeRef = doc(db, "FoodRecipes", recipeId);
          const recipeSnap = await getDoc(recipeRef);

          if (!recipeSnap.exists()) {
            alert("Recipe not found!");
            //window.location.href = "index.html";
            return;
          }

          const recipe = recipeSnap.data(); // ← CHỐT Ở ĐÂY

          /* ========= LẤY USER ========= */
          if (!recipe.userId) {
            alert("Recipe has no author!");
            //window.location.href = "index.html";
            return;
          }

          const userRef = doc(db, "users", recipe.userId);
          const userSnap = await getDoc(userRef);

          if (!userSnap.exists()) {
            alert("Author not found!");
            //window.location.href = "index.html";
            return;
          }

          const user = userSnap.data();

          /* ========= RENDER UI ========= */
          document.querySelector("#title").innerText = recipe.title;
          document.querySelector(".hero_img").src = recipe.img;
          document.querySelector("#avatar img").src =
            user.avatarUrl || "default-avatar.png";
          document.querySelector("#name").innerText = `by ${user.fullName} `;
          document.querySelector("#date").innerText = `${recipe.createdAt} `;
          document.querySelector(".description").innerHTML = `${recipe.des}`;
        } catch (error) {
          console.error(error);
          alert("Failed to load recipe");
          window.location.href = "index.html";
        }
      }

      loadRecipe();
    </script>
  </body>
</html>
